import { Color, RepeatWrapping, Vector2, VideoTexture } from "three";
import loadTexture from "../../utils/loaders/loadTexture";
import { objectURLMapperPtr } from "../../utils/loaders/setObjectURLMapper";
import { Reactive } from "@lincode/reactivity";
import { debounce } from "@lincode/utils";
const mapNames = ["map", "alphaMap"];
const textureRepeatMap = new Map();
const applyTextureRepeat = debounce(function () {
    for (const [item, repeat] of textureRepeatMap) {
        for (const name of mapNames) {
            const map = item.material[name];
            map && (map.repeat = repeat);
        }
    }
    textureRepeatMap.clear();
}, 0, "trailing");
export default class TexturedBasicMixin {
    get color() {
        return "#" + this.material.color.getHexString();
    }
    set color(val) {
        this.material.color = new Color(val);
    }
    get vertexColors() {
        return this.material.vertexColors;
    }
    set vertexColors(val) {
        this.material.vertexColors = val;
    }
    get fog() {
        return this.material.fog;
    }
    set fog(val) {
        this.material.fog = val;
    }
    get opacity() {
        var _a;
        return (_a = this._opacity) !== null && _a !== void 0 ? _a : (this._opacity = 1.0);
    }
    set opacity(val) {
        var _a;
        this._opacity = val;
        this.material.opacity = val;
        this.material.transparent = (_a = this.transparent) !== null && _a !== void 0 ? _a : val < 1;
        //@ts-ignore
        this.object3d.visible = !!val;
    }
    basicTextureRepeat() {
        this.material.needsUpdate = true;
        if (!this._textureRepeat)
            return;
        textureRepeatMap.set(this, this._textureRepeat);
        applyTextureRepeat();
    }
    initTexture() {
        var _a, _b;
        if (this.textureState)
            return;
        const videoTextureState = (_a = this.videoTextureState) !== null && _a !== void 0 ? _a : (this.videoTextureState = new Reactive(undefined));
        const textureState = (_b = this.textureState) !== null && _b !== void 0 ? _b : (this.textureState = new Reactive(undefined));
        //@ts-ignore
        this.createEffect(() => {
            const url = textureState.get();
            let videoURL = videoTextureState.get();
            if (!videoURL && ((typeof url === "string" && objectURLMapperPtr[0](url).toLowerCase().endsWith(".mp4")) ||
                (url && url instanceof HTMLVideoElement))) {
                videoURL = url;
            }
            if (videoURL) {
                let video;
                if (videoURL instanceof HTMLVideoElement)
                    video = videoURL;
                else {
                    video = document.createElement("video");
                    video.crossOrigin = "anonymous";
                    video.src = videoURL;
                    video.loop = true;
                    video.autoplay = true;
                    video.muted = true;
                    video.playsInline = true;
                    video.play();
                }
                const videoTexture = new VideoTexture(video);
                videoTexture.wrapS = videoTexture.wrapT = RepeatWrapping;
                const { material } = this;
                const { map } = material;
                material.map = videoTexture;
                material.needsUpdate = true;
                this.basicTextureRepeat();
                return () => {
                    video.pause();
                    videoTexture.dispose();
                    material.map = map;
                    material.needsUpdate = true;
                };
            }
            if (!url)
                return;
            const { material } = this;
            const { map } = material;
            material.map = loadTexture(url);
            this.basicTextureRepeat();
            return () => {
                material.map = map;
                this.material.needsUpdate = true;
            };
        }, [videoTextureState.get, textureState.get]);
    }
    get videoTexture() {
        var _a;
        return (_a = this.videoTextureState) === null || _a === void 0 ? void 0 : _a.get();
    }
    set videoTexture(url) {
        this.initTexture();
        this.videoTextureState.set(url);
    }
    get texture() {
        var _a;
        return (_a = this.textureState) === null || _a === void 0 ? void 0 : _a.get();
    }
    set texture(url) {
        this.initTexture();
        this.textureState.set(url);
    }
    get alphaMap() {
        return this._alphaMap;
    }
    set alphaMap(val) {
        this._alphaMap = val;
        this.material.alphaMap = val ? loadTexture(val) : null;
        this.basicTextureRepeat();
    }
    get textureRepeat() {
        return this._textureRepeat;
    }
    set textureRepeat(val) {
        typeof val === "number" && (val = new Vector2(val, val));
        this._textureRepeat = val;
        this.basicTextureRepeat();
    }
}
